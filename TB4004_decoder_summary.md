# TB4004 命令デコード部 実装まとめ

## 1. 命令セット一覧（i4004準拠）

- **制御系**
  - `NOP` : 無操作
  - `JCN` : 条件付きジャンプ
  - `JUN` : 無条件ジャンプ
  - `JMS` : サブルーチンコール
  - `BBL` : リターン（即値をACCにロード）
  - `ISZ` : レジスタインクリメント＋条件付きジャンプ
  - `JIN` : インデックスジャンプ

- **レジスタ/メモリ操作系**
  - `FIM` / `SRC` : レジスタペア即値ロード / アドレス指定
  - `FIN` : ROM間接ロード
  - `INC` : レジスタインクリメント
  - `LD`  : レジスタ→ACC
  - `XCH` : ACCとレジスタの交換
  - `LDM` : 即値→ACC

- **算術系**
  - `ADD` / `ADM` : 加算（レジスタ / RAM）
  - `SUB` / `SBM` : 減算（レジスタ / RAM）

- **I/O・RAMアクセス系**
  - `WRM`, `RDM` : RAM書き込み / 読み出し
  - `WRR`, `RDR` : ROM出力 / 入力ポート
  - `WMP`, `WR0..WR3`, `RD0..RD3` : RAMポート操作

- **フラグ・ACC制御系**
  - `CLB`, `CLC`, `IAC`, `CMC`, `CMA`, `RAL`, `RAR`, `TCC`, `DAC`, `TCS`, `STC`, `DAA`, `KBP`, `DCL`

---

## 2. 仕様の手本
- **ベース仕様** : Intel i4004 マニュアル準拠
- **アドレス幅** : 12bit PC（4KB空間）
- **レジスタ** : 16個（8ペア）
- **フラグ** : Carry, Zero, TEST入力
- **マイクロサイクル** : A1(0)〜X3(7) の8ステップ固定

---

## 3. 開発の決まり
1. **副作用は全てX3で確定**
2. **2語命令は needImm フラグでフェッチ制御**
3. **レジスタペアは偶数境界で管理**
4. **命令ごとにALU入力ソースを統一的に制御（aluSel）**
5. **フラグ更新は算術系命令のみ（LD等はZeroのみ更新）**
6. **MMIO窓ヒット時のRAM誤書きはcpuTop側で抑止**

---

## 4. 成果
- i4004の全命令をVerilogでデコード実装
- 2語命令（JCN/JUN/JMS/ISZ/FIN/FIM）の即値フェッチハンドシェイク確立
- CCoutロジックをi4004準拠で実装（TEST/CARRY/ZERO判定＋反転ビット）
- スタックからのPC復帰機構（stackPcLoad）を組込み
- BRAM化によるFPGAリソース削減（Gowin向け）

---

## 5. 工夫した点
- **zeroFromAluX2ラッチ**により、ISZ分岐判定を安全化
- **pcLoadUsePair**でJIN命令を簡潔に実装
- **finImm**によりFINのROMアクセス切替を1フラグで管理
- 命令別に`aluSel`と`aluOp`の設定パターンを整理し可読性向上
- 同期ROM/RAMの1クロックレイテンシを吸収するマイクロサイクル設計

---

## 6. 注意事項
- フラグ更新が不要な命令での誤更新に注意
- ISZ/JCNは第2語のX3でのみPC変更（第1語での誤作動防止）
- 同期ROM使用時はM1/M2のラッチタイミング要確認
- TEST入力は同期化してCCout計算に使用
- レジスタファイルは組合せ読み出し前提（同期型の場合はタイミング調整が必要）

---

## 7. 今後の展開
1. **波形シミュレーションによる全命令検証**
2. **i4004用アセンブリコード実行テスト**
3. **MMIO機能拡張（外部I/O接続）**
4. **性能計測とタイミングクロージャ最適化**
5. **ドキュメント化・アーキテクチャ図の整備**

---

**最終更新** : 2025-08-13
